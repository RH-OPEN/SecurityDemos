== Lab 4: Red Hat AdvancedClusterSecurity を使用したアプリケーションへの自動化セキュリティの実装とDevSecOpsの構築

=== ラボの目的

このラボの目標は、さまざまなセキュリティツールの組み合わせをオーケストレーションする、安全なソフトウェアファクトリを構築する方法を学ぶことです。DevSecOps の出現により、セキュリティは前面と中心に置かれ、人、プロセス、および、技術の面で対処されるようになりました。セキュリティツールはビルドプロセスに統合されており、CI/CDパイプラインに組み込まれたセキュリティゲートでセキュリティ要件が満たされない場合、ビルドを簡単に中断することができます。

=== 序章

DevOpsと継続的インテグレーション／継続的デリバリー（CI/CD）の利点は、長年にわたって大きな成果とともに実証されてきました。組織は常に、より少ない人数でより多くのことを行うことを求めてきました。セキュリティは多くの場合、ソフトウェア提供プロセスの末端のアドオンとして扱われ、ソフトウェアデリバリの遅延につながることも少なくありませんでした。業界は、これを変えなければならないことを認識しました。組織は、契約上および規制上の義務や社内のセキュリティ標準を引き続き満たす必要がありますが、機会を生かすためにソフトウェアデリバリを加速させる必要があります。組織がこれらの標準を満たし、DevOpsのスピードでデリバリーできるようにするために、セキュリティは、無関係になるか、最新のソフトウェアデリバリプラクティスに適合するかの選択に迫られています。セキュリティはソフトウェアを迅速に提供するために不可欠であり、ソフトウェア品質の指標となっているため、"DevOps" に "Sec" を含めることが推奨されています。DevSecOpsの登場により、Shift Leftはソフトウェアデリバリプロセスの早い段階で不具合を発見し、防止することを目的としたプラクティスとなりました。セキュリティツールは、ビルドプロセスに直接統合されます。その結果、CI/CDプロセスをより速く進め、デリバリーまでの期間を短縮しながら、各リリースの品質を継続的に向上させることができるのです。+
この実習では、典型的な CI/CD アプリケーションパイプラインに自動化されたセキュリティコンプライアンス制御を実装するために使用される技術のいくつかに焦点を当てます。 +
DevSecOps パイプラインをサポートするために、多くのツールがインストールされ、事前に設定されています。これらのツールのほとんどは、Red Hat OpenShift クラスター内でコンテナ化されて実行されています。以下は、私たちのラボでステップスルーするパイプラインです:

image:images/lab4-devsecops01.png[800,800]

DevSecOpsのCI/CDパイプラインでは、次のような技術を使用します:

- https://tekton.dev[Tekton] をベースとした https://www.openshift.com/learn/topics/ci-cd[OpenShift Pipelines] 
- https://argoproj.github.io/[ArgoCD] をベースとした https://www.openshift.com/blog/announcing-openshift-gitops[OpenShift GitOps]
- https://www.redhat.com/en/resources/advanced-cluster-security-for-kubernetes-datasheet[Red Hat Advanced Cluster Security for Kubernetes]
- https://docs.openshift.com/container-platform/latest/registry/architecture-component-imageregistry.html[OpenShift Container Registry]
- https://www.sonarqube.org/[SonarQube]
- https://www.sonatype.com/products/repository-oss?topnav=true[Nexus]
- https://junit.org/junit5/[JUnit]
- https://gogs.io/[Gogs]
- https://tekton.dev/docs/triggers/[Git Webhook]
- https://gatling.io/[Gatling]
- https://www.zaproxy.org/[Zap Proxy]

[#beforeyoustart]
=== 始める前に

講師からの情報は、このラボで使用されます:

- RHEL 8 VM (bastion)へのユーザー名とパスワードによるアクセス
- OpenShift コンソール URL
- OpenShift API サーバ
- OpenShift 管理者のユーザ名とパスワード

以下は登録情報の一例です:

image:images/lab4-devsecops02.png[800,800]

=== ユーザー要件

- 最新のブラウザー: ChromeとFirefoxを推奨
- コマンドラインと'oc'ツールは、ラボに付属しているBastion VMに含まれています。

* 以下のコマンドのように、割り当てられた VM に SSH 接続します:
+
[source]
----
 ssh lab-user@bastion.GUID.sandbox####.opentlc.com
----
+
* oc コマンドラインユーティリティが使用可能かどうかを確認するには、ターミナルを開いて以下のコマンドを実行します:
+
[source]
----
 oc version
----
+
* コマンドラインからコンソールの URL を取得する場合:
+
[source]
----
oc login -u admin api.cluster-{GUID}.{GUID}.sandbox###.opentlc.com:6443
----
+
‘oc login’ のAPIサーバー情報は、xref:beforeyoustart[始める前に] に記載されています。
+
* また、ラップトップでocクライアントをセットアップする場合は、以下の手順を実行します:
+
** OpenShift コンソールにログインしてください。OpenShiftコンソールの管理者ユーザーパスワード情報は、講師から提供されます。
右上のクエスチョンマークを選択し、“Command Line Tools” を選択します。
+
image:images/lab4-devsecops03.png[200,200]
+
** 選択したオペレーティングシステム用のocコマンドラインツールをダウンロードします。
** ocコマンドラインツールをシステムの実行ファイルの場所に移動しておくと、演習中に簡単にアクセスできるようになります。
+
例えばMacbookの場合、次のコマンドを実行します。
+
|===
|mv <insert-download-path> /usr/local/bin /usr/local/bin/
|===
+
* インターネット接続可能なラボ環境
* GitHub へのインターネットアクセス

=== Lab 4.1 継続的インテグレーション

この最初のモジュールは、OpenShift Pipeline を実行し、サンプルの安全なパイプラインのステップを探ってみましょう。 +
このラボでは、Tekton パイプラインの開始方法と、開発ライフサイクル内でセキュリティと gitops ツールを統合するためのタスクの使用方法を学習します。

. パイプラインを開始するには、3つの方法があります:
** Option 1: Developer UIを使用して開始する
.. ブラウザで OpenShift Console の URL を参照する。
.. 提供された認証情報を使用してコンソールにログインする。
.. まだ開発者パースペクティブにいない場合は、左上の開発者コンソールに切り替えるためにDeveloperを選択します。
+
image:images/lab4-devsecops04.png[200,200]
+
.. ocp-workshop "プロジェクトに移動します。
+
image:images/lab4-devsecops05.png[200,200]
+
.. 左メニューの 'Pipelines' をクリックすると、すべてのパイプラインが表示されます。
+
image:images/lab4-devsecops06.png[400,700]
+
.. " petclinic-build-dev "パイプラインをクリックします。
+
image:images/lab4-devsecops07.png[600,800]
+
.. 右上の “Actions” をクリック → “start” を選択
+
image:images/lab4-devsecops08.png[200,700]
+
.. "Workspaces"でPVCを選択し、パイプラインが実行時に使用する共有ストレージのパスとしてPVC petclinic-build-workspaceを選択します。
.. "maven-settings" で「Config Map」を選択し、"maven-settings" をConfig Mapとして選択します。
.. start をクリック
+
** Option 2: コマンドラインからパイプラインを起動する。
コマンドラインはテスト中にパイプラインを開始するのに便利な方法で、PRやgitへのpushをシミュレートしてパイプラインを起動させる方法です。CLIでパイプラインを開始するのが好きなユーザー向けです。
+
.. 実行:
+
[source]

|===
|oc create -f https://raw.githubusercontent.com/RedHatDemos/SecurityDemos/master/2021Labs/OpenShiftSecurity/documentation/labs-artifacts/pipeline-build-dev-run.yaml -n ocp-workshop

|===
+
** Option 3: 新しいコードがgit repoにpushされると、パイプラインを開始するトリガーにもなります。このラボでは、git repo は Gogs です。以下の手順は、「Gogs」git repo経由でコードをプッシュするためのものです。
このオプションは、開発者の観点からすると最もポピュラーなものかもしれません。PR や git リポジトリへのプッシュからパイプラインが始まり、webhook が自動的にパイプラインを開始します。
+
.. 開発コンソールから、左のナビメニューにある `Search` をクリックします。
.. 'route'と入力し、リストの中から`Route`をクリックします。
+
image:images/lab4-devsecops09.png[400,400]
+
.. `Gogs` ルートをクリックすると、gogs の URL が表示されます:
+
image:images/lab4-devsecops10.png[400,600]
+
.. `Sign In`サインイン`をクリックし、_gogsadmin_の認証情報でログインします。
+
image:images/lab4-devsecops11.png[500,400]
+
|===
|User: gogsadmin
|Password: openshift
|===
+
.. gogsadminアカウント内のspring-petclinicリポジトリを選択します:
+
image:images/lab4-devsecops12.png[400,700]
+
.. README.mdをクリックし、`Edit this file`をクリックし、変更を加えてください:
+
image:images/lab4-devsecops13.png[400,700]
+
.. 導入した変更をREADME.mdにコミットします:
+
image:images/lab4-devsecops14.png[400,700]
+
[注意] これはあくまでデモのためのものです。通常、master への push は推奨されず、代わりに他のブランチ (例えば develop) からの Pull Request / Merge Request を使用します。
+
.. パイプラインは自動的にトリガーされます。このラボのステップ 6 にスキップして、Pipeline Runs コンソールを確認してください。
+
. 提供されたOpenShiftコンソールのURLを使って、ブラウザを開きます。
. 提供されたクレデンシャルを使用してコンソールにログインします。
. `Developer`をクリックすると、開発者用コンソールに切り替わります。
+
image:images/lab4-devsecops04.png[200,200]
+
. `OCP-Workshop`プロジェクトが選択されていることを確認してください。
+
image:images/lab4-devsecops15.png[300,300]
+
. 左メニューの `Pipelines` をクリックすると、すべてのパイプラインが表示されます。
+
image:images/lab4-devsecops16.png[400,700]
+
. パイプラインの `petclinic-build-dev` をクリックし、`Pipeline Runs` タブをクリックします。
+
image:images/lab4-devsecops17.png[400,700]
+
. パイプラインの実行をクリックします。
+
起動すると下図のようなPipeline Runが表示されますので、ご覧ください。
+
image:images/lab4-devsecops18.png[500,700]
+
パイプライン実行のステップ「image-check」で失敗します。これは、イメージに含まれる重要な深刻度の脆弱性がパイプラインゲートポリシーに引っかかり、デプロイが停止するためです。
+
image:images/lab4-devsecops20.png[500,700]
+
パイプラインを正常に完了させるためには、この脆弱性を修正する必要があります。次のモジュールでそれを行います。以下は、正常に実行された場合の様子です。
+
image:images/lab4-devsecops19.png[500,700]
+
次のモジュール、Lab 4.2では、何が起こったのか、それを安全に解決する方法について説明します。
+
[注意] 手動でパイプラインを実行するトリガーに加え、Gogs gitサーバー上のspring-petclinic gitリポジトリにpushするたびに、パイプラインが実行されます。
. パイプラインを探索しようパイプラインが開始されると、各詳細なステップをクリックして、各ステップのログを探索することができます。次の数ステップで探索の一部を指示します。
.. *Source Clone* - アプリのソースコードは、このラボにインストールされているGit（Gogs）サーバーから引き出されています。
+
[注意] ファイルは、パイプラインにあらかじめ設定されたワークスペースを介して、パイプラインのステップ間で持続されます。
+
image:images/lab4-devsecops24.png[400,700]
+
... git repo の URL をコピーします。ブラウザのタブを開いて、コードを探索する
... URLは以下のようにGogsのgit repoに移動します。
+
image:images/lab4-devsecops25.png[600,700]
+
... `gogsadmin`をクリックすると、このラボのための2つのリポジトリがあります。
+
gogsadminユーザの認証情報は以下の通りです:
+
|===
|User: gogsadmin
|Pass: openshift
|===
+
.. *Dependency Report* は、ソースコードからアプリの依存関係のレポートを作成し、レポートサーバーリポジトリにアップロードするパイプラインのステップです。
+
image:images/lab4-devsecops26.png[300,700]
+
reportを見てみましょう!
+
... 開発コンソールから、左のナビメニューにある `Search` をクリックします。
... Resourcesをクリックし、`route`と入力、リストから`Route`をクリックします。
+
image:images/lab4-devsecops09.png[400,400]
+
... reports-repo のリンクをクリック。
+
image:images/lab4-devsecops27.png[300,700]
+
... このページの `petclinic-build` リンクをクリックします。
+
image:images/lab4-devsecops28.png[300,500]
+
... 引き続き、spring-petclinic → target → site をクリックします。
... そのページから `Dependencies` をクリックします。そのページから、下にスクロールすることで詳細を調べることができます。
+
image:images/lab4-devsecops29.png[300,700]
+
.. *Unit tests* タスクは、依存性レポートと並行して実行されます。
+
image:images/lab4-devsecops30.png[300,700]
+
. *Release-app* はアプリケーションをJARとしてパッケージ化し、Sonatype Nexusのスナップショットリポジトリにリリースする場所です。
+
image:images/lab4-devsecops31.png[300,700]
+
. *Build-image* ステップは、DEV環境でS2Iを使ってコンテナイメージをビルドし、OpenShiftの内部レジストリにプッシュし、spring-petclinic:[branch]-[commit-sha] および spring-petclinic:latest でタグ付けします。
+
image:images/lab4-devsecops32.png[300,700]

=== Lab 4.2 Advanced Cluster Securityを利用したDevSecOpsのステップ

Red Hat Advanced Cluster Security (ACS) for Kubernetes は、ビルトインのセキュリティポリシーにより、単一のコンソールからクラスタとアプリケーションを制御します。 +
第一世代のコンテナセキュリティプラットフォームは、コンテナに焦点を当てます。ACSはKubernetesにフォーカスしており、Kubeの宣言型データとビルトイン制御を活用したKubernetesネイティブアーキテクチャにより、リッチなコンテキスト、ネイティブな実施、継続的なハードニングを実現し、DevOpsとセキュリティチームのセキュリティ運用を支援します。さらに、ACS focuses on Kubernetesは、DevOpsおよびセキュリティチームがセキュリティを運用できるよう支援し、クラウドネイティブなアプリケーションスタックを保護するプロセスを簡素化します。

このラボでは、ACS が CI/CD プロセスにどのように統合されるかを学びます。ACSはプロセスを簡素化するだけでなく、組織内のセキュリティチームに可視性を提供します。
 https://docs.openshift.com/acs/cli/getting-started-cli.html[roxctl] ACS API を使って、いくつかの追加のセキュリティステップを DevSecOps のパイプラインに統合しました:

. *image scan* のステップでは、ACSスキャナを使用して、最後のステップで生成され、プッシュされたイメージをスキャンします。
+
image:images/lab4-devsecops33.png[300,700]
+
ログにある以下のエラーは、`pretty` フォーマットが非推奨であることが原因です。
+
|===
|ERROR:	invalid output format "pretty" used. You can only specify json or csv
|===
+
フォーマットを変更するには、以下の手順で行います。

.. 左のメニューから `Pipelines` をクリックします。
.. `petclinic-build-dev` パイプラインをクリックします。
.. `Actions` -> `Edit Pipeline`をクリックします。
.. `image-scan` タスクをクリックし、`pretty` の代わりに `csv` を使用します。
+
image:images/lab4.2-image-scan.png[500,700]
+
.. `Save`をクリックします。
.. オプションで `Actions` -> rerun を選択すると、イメージスキャンの実際の出力が表示されます。
+
image:images/lab4.2-image-scan-withlogs.png[500,700]
+
このステップのログには、ACSのイメージスキャンへの直接のリンクがあります。
+
[注意] もし、そのリンク先にセキュリティ証明書の警告が表示されても無視してください。 +
コピーして別のタブに貼り付けると、スキャンしたイメージの詳細な情報を得ることができます。以下の情報を入力してください:
+
|===
|User: admin
|Pass: stackrox
|===
+
URLは、Vulnerability Managementに移動します。この画像に含まれる脆弱性(CVE)の概要を説明します。
+
image:images/lab4-devsecops35.png[500,700]
+
.. Deployment タブで、ACSツールはこのイメージがデプロイされているかどうかを認識します。最初のパイプラインはすべてのゲートを通過しなかったので、最初はデプロイメントが表示されないでしょう。


.. Component タブは、このイメージ内のすべてのコンポーネントのビューです。コンポーネントのアップグレードで修正可能な CVE の数、コンポーネントの CVE に関連する CVSS スコアのトップ、各コンポーネントを含む他のデプロイメントなどの関連情報が一覧表示されます。

+
image:images/lab4-devsecops34.png[500,700]
+
例えば、tomcat 9.0.31 コンポーネントをクリックすると、下図のようにコンポーネントの詳細が表示されます。このページには、リスクの優先順位、CVE の情報、コンポーネントの場所、CVE を修正するためにアップグレードするコンポーネントのバージョンが表示されます。
+
image:images/lab4.2-tomcat-cve.png[500,700]
+
.. 右上の “X” をクリックすると戻ることができます
.. CVEsタブは、画像のすべての脆弱性を表示します。
+
image:images/lab4-devsecops36.png[500,700]
+
.. `Overview` タブに戻り、`Image findings` セクションにスクロールダウンすると、修正可能な CVE が表示されます。これらは、ACS が修正可能であることを認識している CVE です。
+
image:images/lab4-devsecops37.png[300,700]
+
.. `Image Findings`セクションの上にある `Dockerfile` セクションを '>' をクリックして展開すると、ACS CVEデータベースにより、各ステップごとに詳細なイメージコンポーネントと関連するCVEが表示されます。
+
image:images/lab4-devsecops38.png[400,700]
+
パイプラインの復習を続ける前に、ACSの探索を自由に行ってください。セキュリティチェックとツールの機能を理解することは、このラボの重要な部分であり、安全なソフトウェア配信パイプラインの知識を高めるのに役立ちます。
+
ここで、OpenShift Developerのコンソールに戻ります。
. パイプラインの *Image Check* ステップ
+
[注意] ACSで定義されている様々なセキュリティポリシーのビルド時の違反
+
image:images/lab4-devsecops39.png[400,700]
+
image:images/lab4-devsecops40.png[400,700]
+
このステップでは、このイメージを使用するすべてのデプロイメントについて、ACS で定義されたセキュリティ ポリシーのビルド時およびデプロイ時の違反をチェックします。セキュリティポリシー違反のため、ACSでセキュリティポリシーの実施を設定したため、このパイプラインはこのタスクで失敗します。
脆弱性の高いコンテナ型アプリケーションを展開しないためには、イメージのスキャンが重要です。

. *Deploy-check* は、ログにポリシーの違反が表示されます。ログには違反が表示されていますが、この例ではデプロイの強制がオンになっていないため、このタスクで失敗することはありませんでした。この後のラボで、ポリシーの詳細を確認します。
+
image:images/lab4-devsecops41.png[400,700]
+
[注意] この3つのステップ（*deploy-check, image-check, image-scan*）は、DevSecOpsパイプラインの時間短縮のために並行して実行されます。
+
. もし *image-check* が失敗したら、パイプラインの実行に移動して `image-check` をクリックします。ログの一番下に `Error: failed policies found: 1 policy violated that are failing the check.` と表示されます。このエラーの原因は、違反が発生した場合に ACS がビルドやデプロイからポリシーを強制するためです。パイプラインでは、Tektonタスクのroxctlを介してACSを統合しています。
+
Imageがポリシーに違反した場合、コードを修正し、チェックに合格するまでパイプラインを実行することがベストプラクティスです。ログには違反の一覧と対処法が報告されています。開発者は `image-check` タスクのログから情報を取得し、それに応じて変更を加えることができます。修正がGitにチェックインされると、パイプラインが起動されます。今回、xref:fiximage[画像を修正するためのボーナスエクササイズ]を用意しました。もし、パイプライン上で他のタスクのテストを続けたい場合は、ポリシーに例外を追加して、spring-petclinicを除外することができます。
ポリシーに例外を追加することは、開発者がコードを修正する必要があり、CIプロセスがテストを継続する必要がある場合に有効である。
+
[注意] 違反が通るようにコードを修正することが推奨されるアプローチになることに注意してください。
+
spring-petclinicビルドのポリシーをバイパスする例外を追加したい場合を想定しています。
+
.. *image-check* タスクのログを調べると、以下のような失敗の原因となるメッセージが見つかります:
+
|===
|✗ Image image-registry.openshift-image-registry.svc:5000/ocp-workshop/spring-petclinic@sha256:ece54d2923654c36f4e97bc0410f5c027871c5b7483e977cfc6c2bd56fef625d and '*ERROR: Policy "Fixable Severity at least Important"*'
|===
+
.. `ワッフルアイコン` image:images/lab4-devsecops42.png[20,20] をクリックしてコンソールリンクを表示 → 以下のように `Red Hat Advanced Cluster Security For Kubernetes` を選択します。
+
image:images/lab4-devsecops43.png[700,300]
+
.. ACSコンソールにログインするよう促されます → `Advanced` をクリック → `Proceed to central-stackrox.apps.cluster...` リンクをクリックして進みます。
.. 以下の情報を入力してください:
+
|===
|User: admin
|Pass: stackrox
|===
+
.. ログインをクリックし、以下のようにパイプラインを再実行します。
+
image:images/lab4-devsecops44.png[300,700]
+
.. 左上の image:images/lab4-devsecops45.png[20,20] をクリック → Platform Configuration をクリック → Policies を選択します。
+
image:images/lab4-devsecops46.png[100,200]
+
.. Policies の下にある検索フィールドに、ポリシー名 *Fixable Severity at least Important* を入力し、Enterキーを押します。結果、ポリシーが表示されます。
+
image:images/lab4-devsecops47.png[300,700]
+
[注意] UI上で https://issues.redhat.com/browse/ROX-9938[bug] に遭遇したため、ACS UI経由でポリシーにビルドイメージの例外を追加することができなくなります。ここでの手順は、回避策です。ACS v3.70では、SHAなしでUI経由でビルドイメージを追加できるようになります。
+
* `Fixable Severity at least Important` をクリックすると、ポリシーの詳細ページが表示されます。ポリシーページでは、`Actions` の下でポリシーの編集、クローン、エクスポート、無効化ができます。`Actions` の下にある 'Clone policy' をクリックします。開発者はガイダンスの情報を使って、イメージを修正することができます。ライフサイクルステージの情報は、ポリシーの強制が行われる場所です。有効なポリシーに違反しているため、パイプラインのビルドとデプロイのステージを通過することはできません。
+
image:images/lab4-devsecops48.png[300,700]
+
* クローンポリシー名を `Fixable Severity at least Important - with Exception` と入力します。
+
image:images/lab4.2-5-clone-policy-name.png[300,700]
+
* `Next` をクリックします。
* ポリシーの動作で `Next` をクリックします。
* 画像を除外するために、Policy criteria の `Next` をクリックし、Policy scope セクションの UI を表示します。
* Exclude imagesセクションで、`Excluded Images (Build Lifecycle only)` リストのオプションをフィルタリングするために以下をタイプします:
+
|===
|image-registry.openshift-image-registry.svc:5000/ocp-workshop/spring-petclinic
|===
+
* spring-petclinic のImageを1つ選択してください。
+
image:images/lab4.2-5-exclude-image.png[300,700]
+
* `Next` をクリックします。
* `Save` をクリックする前に、ポリシーをご確認ください。
* ここで、新しく作成した Image例外ポリシー `Fixable Severity at least Important - with Exception` を更新する必要があります。
* 左メニューの `Policies` をクリックします。
* `Fixable Severity at least Important - with Exception` のポリシーを検索してください。
+
image:images/lab4.2-5-exceptionPolicy.png[300,700]
+
* ポリシーをクリックします。
* Actions をクリック -> Export policy to JSON をクリック
+
image:images/lab4.2-5-exportPolicy.png[300,700]
+
* 選択したローカルファイルシステムとして保存します。
* JSONファイルをお好みのエディタで開きます。
+
image:images/lab4.2-5-editPolicy.png[300,700]
+
* Image名から `@sha256:..` 以降のSHA部分を削除します。
+
image:images/lab4.2-5-editpolicy2.png[300,700]
+
* ファイルを保存します。
* ACS コンソールに戻り、 `Fixable Severity at least Important - with Exception` ポリシー詳細ページで、 `Actions` -> `Delete policy` を選択します。
* 左メニューの `Policies` をクリックします。
* 右上の `Import policy` をクリックします。
* `Upload` をクリックし、編集したJSONファイルを選択します。
+
image:images/lab4.2-5-importPolicy.png[200,500]
+
* `Begin import` をクリックします。
* ポリシー 'Fixable Severity' を選択してください。
+
image:images/lab4.2-5-filterPolicy.png[300,700]
+
* `Fixable Severity at least Important` の末尾の3点アイコンをクリック -> select `Disable policy` を選択します。
+
image:images/lab4.2-5-disablePolicy.png[300,700]
+
.. これで、`Fixable Severity`のポリシーは以下のようになります。
+
image:images/lab4.2-5-2Policy.png[300,700]
+
.. OpenShift developer console に戻り、ナビの “ocp-workshop” プロジェクトの下にあるパイプラインをクリックします。
+
image:images/lab4-devsecops52.png[300,700]
+
.. パイプラインを再実行します。
+
image:images/lab4-devsecops53.png[300,700]
+
.. Pipeline Runsタブをクリックし、開始したPipeline Runをクリックします。
+
image:images/lab4-devsecops54.png[300,700]
+
image:images/lab4-devsecops55.png[300,700]
+
.. xref:fiximage[bonus lab] でImageを修正し終えたら、ポリシーに戻って、ポリシーの例外を削除します。

.. Kubernetes kustomization ファイルは、*update deployment step* で、dev用のオーバーレイにある最新のイメージ [commit-sha] で更新されます。これにより、私たちのアプリケーションは、このパイプラインで特定のビルドされたイメージを使用してデプロイされることが保証されます。
+
image:images/lab4-devsecops56.png[300,700]


=== Lab 4.3 Continuous Delivery Using GitOps

GitOps is a declarative way to implement continuous deployment for cloud-native applications. We can use GitOps to create repeatable processes for managing OpenShift Container Platform clusters and applications across multi-cluster Kubernetes environments. GitOps handles and automates complex deployments at a fast pace, saving time during deployment and release cycles. +
The GitOps workflow pushes an application through development, testing, staging, and production. GitOps either deploys a new application or updates an existing one, so we only need to update the repository; GitOps automates everything else.

Argo CD continuously monitors the configurations stored in the Git repository and uses Kustomize to overlay environment-specific configurations when deploying the application to DEV and STAGE environments.

image:images/lab4-devsecops57.png[300,700]

. The ArgoCD application syncs the manifests in our Gogs git repositories, and applies the changes automatically into the namespaces defined:
.. Click on the waffle icon on the top to get to the console links and select “Cluster Argo CD”
+
image:images/lab4-devsecops43.png[300,300]
+
.. The link redirects to the Argo CD login. If it is the first time logging in to Argo CD, please click `Advanced` → `Proceed to openshift-gitops-server-openshift-gitops.apps…` link.
.. In order to be able to log in as an "admin" user, please first retrieve its password by running the command as shown below.
+
[source]
----
oc get secret/openshift-gitops-cluster -n openshift-gitops -o jsonpath='{.data.admin\.password}' | base64 -d
----
+
.. Once logged in, the applications are listed on the Argo CD console as shown below.
+
image:images/lab4-devsecops58.png[500,600]
+
.. Click onto `dev-spring-petclinic` to access the application.
. ArgoCD will deploy every manifest that is defined in the branch/repo of our application. The application shows “Synced”.
+
image:images/lab4-devsecops59.png[300,700]
+
.. Click image:images/lab4-devsecops101.png[100,90] to view the details of the `dev-spring-petclinic` application.
+
image:images/lab4-devsecops102.png[900,700]
+
.. The details above show the namespace where the application is deployed. Back to the OpenShift Dev console, click `Topology` on the left navigation menu under devsecops-dev project. Click the arrow to access the application URL.
+
image:images/lab4-devsecops60.png[300,500]
+
* Application shows as below.
+
image:images/lab4-devsecops61.png[500,500]
+
.. Go back to the Argo CD console. Click `Applications` on the top left.
+
[Note] The namespace for `stage-spring-petclinic` is set to devsecops-qa.
+
image:images/lab4-devsecops62.png[300,300]
+
.. Click `stage-spring-petclinic`
+
image:images/lab4-devsecops63.png[300,700]
+
.. Click image:images/lab4-devsecops64.png[40,50] on the top menu to deploy the application to devsecops-qa and wait until “Synced” as shown below.
+
image:images/lab4-devsecops65.png[300,700]
+
.. Back to the OpenShift Dev console, click `Topology` on the left navigation menu under devsecops-qa project. Click the arrow to access the application URL.
+
image:images/lab4-devsecops66.png[300,300]
+
.. The application is now deployed to the devsecops-qa project as shown below.
+
image:images/lab4-devsecops67.png[300,500]

=== Lab 4.4 PostCI - Dynamic Application Security and Testing (DAST)

*Dynamic application security testing (DAST)* is designed to detect conditions indicative of a security vulnerability in an application in its running state. DAST has an important role in helping to identify vulnerabilities in an application during production. Running a DAST penetration test enables us to find those vulnerabilities before an attacker does.
In this lab, ZAP is used to perform application security testing as an example. Performance tests and penetration tests start in parallel after the application is promoted from Dev to QA.

. Our CI in Openshift Pipelines waits until the ArgoCD app is fully synced (*Wait Application step*) and our app and all the resources are deployed
.. Go to the successful pipeline run, and go to the step *wait-application*
+
image:images/lab4-devsecops68.png[300,700]
+
.. Click onto the step, the log is shown below.
+
This step authenticates into an ArgoCD instance and initiates the synchronization process for 'dev-spring-petclinic' application from Git repo (gogs) to the target project in the OCP cluster.
+
image:images/lab4-devsecops69.png[300,700]
+
. Click on the pipeline the step *perf-test-clone*
+
The performance tests are cloned (*Performance Tests Clone*) into our pipeline workspace as shown below.
+
image:images/lab4-devsecops70.png[300,700]
+
. Click onto step *pentesting-test*
+
The pentesting is executed (*Pentesting Test*) using the web scanner https://www.zaproxy.org/[OWASP Zap Proxy] using a baseline to check the possible vulnerabilities. A Zap Proxy report is uploaded to the report server repository.
See the result from the bottom of the log.
+
image:images/lab4-devsecops72.png[300,700]
+
. A performance report is uploaded to the report server repository.
.. Click `Route` on the left navigation, click `reports-repo` route location.
+
image:images/lab4-devsecops73.png[300,700]
+
.. The link has the name that corresponds to the name of the PipelineRun.
.. Please click on the link with the same name as the PipelineRun. A similar link is shown below.
+
image:images/lab4-devsecops75.png[300,400]
+
.. Go to petclinic-build-dev-XXXXXX.html under the route location
+
image:images/lab4-devsecops76.png[300,700]
+
. In parallel, the performance tests are executed using the load test https://gatling.io/[Gatling]. Click “performance-test” from the pipeline run.
+
image:images/lab4-devsecops77.png[300,700]
+
.. Scroll down to see the report location
+
image:images/lab4-devsecops78.png[300,700]
+
.. Go back to the report repo location:
+
image:images/lab4-devsecops79.png[300,400]
+
.. Click on the link that matches the name of Pipeline Run, then select the link corresponding to the "addvisitsimulation" performance test that is also shown in the `performance-test` task log.
+
image:images/lab4-devsecops80.png[200,400]
+
.. Please see the result of the performance test page similar to the image below.
+
image:images/lab4-devsecops81.png[400,700]


=== Lab 4.5 Security Policies and CI Violations

In this demo, we can control the security policies applied to our pipelines, scan the images, and analyze the different deployment templates used to deploy our applications. +
We can enforce the different Security Policies in ACS, failing our CI pipelines if a violation of this policy appears in each step of our DevSecOps pipelines (steps “image-check”, “image-scan”, “deploy-check”).

* Click on the `waffle icon` and select `Red Hat Advanced Cluster Security for Kubernetes`
+
image:images/lab4-devsecops43.png[300,300]
+
* Log in using credential admin/stackrox to ACS console.
+
image:images/lab4-devsecops82.png[300,700]
+
* Click Platform Configuration → Policies
+
image:images/lab4-devsecops83.png[200,200]
+
Security Policies can be defined at the BUILD level (during the build/push of the image), or at the DEPLOYMENT level (preventing the deployment of the application).
* Click on the Package manager policy
+
image:images/lab4-devsecops84.png[300,700]
+
For example, this Security Policy checks if an RH Package Manager (dnf, yum) is in the application Image and will FAIL the pipeline if it detects that the image built contains any RH Package Manager.
* The policy details can be modified. Also, the lifecycle stages are defined by the policy and other properties. The enablement of the Policy option is where the user controls the CI to fail or pass.
+
image:images/lab4-devsecops85.png[300,700]
+
* Click `Actions` -> `Edit policy`
* Click `Next` on `Policy details`
* Select `Inform and enforce` under Response method
* Select `Enforce on Build` for Build
+
image:images/lab4-devsecops87.png[300,700]
+
* Click `Next`, `Next`, `Next` and `Save`
This step ensures that users  have total control of the pipelines. No image is pushed into the image registry or is deployed to the cluster that surpasses the defined Security Policies.


[#fiximage]
=== Bonus suggestion for Lab 4.2: Fixing the image

To show a complete demo and show the transition from a `bad image` to an image that passes the build enforcement, we can update the Tekton task of the image build and fix the image.
In this example, we will be enabling the enforcement of the `Red Hat Package Manager in Image` policy in ACS, which will fail our pipeline at the image-check as both yum and rpm package managers are present in our base image.

. Add an exception to bypass the violation in the *Fixable Severity at least important* policy as we did in the previous section.
. Enable enforcement of the *Red Hat Package Manager in Image* policy:
.. Go to `Platform Configuration` → `Policies`
.. Search for `Red Hat Package Manager in Image` policy
+
image:images/lab4-devsecops88.png[300,700]
+
.. Click onto the `Red Hat Package Manager in Image` policy
.. Click `Actions` -> `Edit policy`
.. Click `Next`
.. Select `Inform and enforce`
.. Ensure select `Enforce on Build` in Build under `Configure enforcement behavior`
+
image:images/lab4-devsecops87.png[300,600]
+
.. Click `Next` until reaching `Review policy` page
.. Click `Save` (if any modification apply)
.. Go to the OpenShift Dev UI, click Pipelines on the left → click `petclinic-build-dev` pipeline → click Actions on the top right corner → select `Start last run`
+
image:images/lab4-devsecops91.png[300,700]
+
.. Check and confirm that it fails on the *image-check* step as the image has the "rpm" and "yum" package managers installed. Notice the suggestion from the *image-check* step:
+
image:images/lab4-devsecops92.png[300,700]
+
.. We will effectively update the image with this remediation suggestion.
. Instead of updating the `s2i-java-11` Tekton task, we are replacing the task.
.. From the OpenShift Administrator UI, make sure the ocp-workshop project is selected before going to Pipelines > Tasks and delete the s2i-java-11 task.
+
image:images/lab4-devsecops93.png[300,700]
+
.. With the Tekton cli
+
|===
|tkn task delete s2i-java-11
|===
+
. Apply the new update task from the command terminal:
+
|===
|kubectl apply -f https://raw.githubusercontent.com/RedHatDemos/SecurityDemos/master/2021Labs/OpenShiftSecurity/documentation/labs-artifacts/s2ijava-mgr.yaml --namespace=ocp-workshop
|or,
|oc apply -f https://raw.githubusercontent.com/RedHatDemos/SecurityDemos/master/2021Labs/OpenShiftSecurity/documentation/labs-artifacts/s2ijava-mgr.yaml  -n ocp-workshop
|===
+
. Re-run the pipeline, the deployment now succeeds. Congratulations to the developers!
. The pipeline run result will be similar to the one below.
+
image:images/lab4-bonus-result.png[300,700]
+
[Note] Please check the https://raw.githubusercontent.com/RedHatDemos/SecurityDemos/master/2021Labs/OpenShiftSecurity/documentation/labs-artifacts/s2ijava-mgr.yaml[*labs-artifacts/s2ijava-mgr.yaml]*** **file for more details on how the image was fixed. We have added a step to the build task, and we leverage buildah to remove the package managers from the image (search for "rpm" or "yum" in the file).
+
image:images/lab4-devsecops94.png[300,700]

=== Bonus exercise: Temporarily Snoozing CVEs

If we just want to snooze a particular CVEs instead of fixing the image and adding an exception to the policy for the build. ACS allows users to temporarily disable the CVEs for a period of time.

[Note] Snoozing the CVEs will temporarily disable the CVEs for all policies.

For this lab, we can snooze the CVEs that cause the image-check to fail and continue to build the pipeline. We will see the image-check task is reporting the violations information from the log.


image:images/lab4-devsecops95.png[300,700]

In some situations, we may want to snooze the CVEs for a period of time. Here are the steps:

. Go to the ACS console via the `waffle icon` and click on the `Red Hat Advanced Clustered Security for Kubernetes` link.
Click Vulnerability Management left menu and click on the CVEs button  on the top.
. We can look for the CVEs to snooze and set up snooze by selecting the duration is needed.
+
image:images/lab4-devsecops96.png[300,700]


=== Bonus exercise: Notification

ACS can be integrated with several Notifiers for alerting if certain events happen in the clusters managed. In our case, we integrated with Slack to receive notifications when some Policies are violated to have more useful information:

image:images/lab4-devsecops97.png[300,500]

These policy notifications can be enabled by each system policy enabled in our system, so we can create our own notification baseline in order to have only the proper information received in our systems. +
Here are the steps to set up slack integration with ACS based on the official https://help.stackrox.com/docs/integrate-with-other-tools/integrate-with-slack/[Integrate with Slack] documentation in Stackrox.

. Create a Slack App, enable Incoming Webhooks and get the Webhook URL using instruction https://docs.openshift.com/acs/3.69/integration/integrate-with-slack.html#configure-slack_integrate-with-slack[here]
+
image:images/lab4-slack.png[300,500]
+
. Select `Platform Configuration` -> `Integration`
+
image:images/lab4-devsecops98.png[100,300]
+
. Click `Slack` and Click `New integration`
. Enter Slack App information in the form below.
+
image:images/lab4-slack-int.png[100,300]
+
. Enable the Notifications in the system policies: Select `Platform Configuration` -> `Policies`
. -> Select a Policy -> Click `Actions` -> `Edit policy`
+
image:images/lab4-devsecops99.png[300,700]

=== Troubleshooting

==== Code Analysis Failures

- Issue:
Sometimes Code Analysis raises an error when mvn is running the maven install 'sonar:sonar':

[source]
----
[[1;31mERROR[m] Failed to execute goal+
[32morg.apache.maven.plugins:maven-compiler-plugin:3.8.1:testCompile[m [1m(default-testCompile)[m on
project [36mspring-petclinic[m: [1;31mCompilation failure[m
[[1;31mERROR[m]
[1;31m/workspace/source/spring-petclinic/src/test/java/org/springframework/samples/petclinic/service/ClinicServiceTests.java:[30,51]
cannot access org.springframework.samples.petclinic.owner.Pet[m
[[1;31mERROR[m] [1;31m  bad class file:
/workspace/source/spring-petclinic/target/classes/org/springframework/samples/petclinic/owner/Pet.class[m
[[1;31mERROR[m] [1;31m    class file contains wrong class:
org.springframework.boot.test.autoconfigure.orm.jpa.DataJpaTest[m
[[1;31mERROR[m] [1;31m    Please remove or make sure it appears in the correct subdirectory of the
classpath.[m
[[1;31mERROR[m] [1;31m[m
[[1;31mERROR[m] -> [1m[Help 1][m
[[1;31mERROR[m]
----

- Resolution:
Just rerun the pipeline and will succeed without changing anything additional. The results will succeed afterward:
[source]
----
[[1;34mINFO[m] Analyzed bundle 'petclinic' with 20 classes+
[[1;34mINFO[m] Analyzed bundle 'petclinic' with 20 classes
[[1;34mINFO[m]
[[1;34mINFO[m] [1m--- [0;32mmaven-jar-plugin:3.1.2:jar[m [1m(default-jar)[m @
[36mspring-petclinic[0;1m ---[m
[[1;34mINFO[m]
[[1;34mINFO[m] [1m--- [0;32mspring-boot-maven-plugin:2.2.5.RELEASE:repackage[m [1m(repackage)[m @
[36mspring-petclinic[0;1m ---[m
[[1;34mINFO[m] Replacing main artifact with repackaged archive
[[1;34mINFO[m] [1m------------------------------------------------------------------------[m
[[1;34mINFO[m] [1;32mBUILD SUCCESS[m
[[1;34mINFO[m] [1m------------------------------------------------------------------------[m
[[1;34mINFO[m] Total time: 01:55 min
[[1;34mINFO[m] Finished at: 2021-07-23T07:37:09Z
[[1;34mINFO[m] Final Memory: 118M/1245M
[[1;34mINFO[m] [1m------------------------------------------------------------------------[m
----

==== JUnit Tests Failures

Refer to the Code Analysis. Just rerun it. It will fix the error.

====  Failure uploading the zap proxy report into the upload server


After the zap proxy task is executed the upload to the report repo server fails due to wrong folder structure:
[source]
----
+ ls -lhrt /zap/wrk
total 76K

-rw-r--r--. 1 zap zap 75K Aug 20 10:41 petclinic-build-devm9hqv.html
+ echo 'Uploading the report into the report server'
Uploading the report into the report server

+ curl -u reports:reports -F path=petclinic-build-devm9hqv.html -F file=/zap/wrk/petclinic-build-devm9hqv.html -X POST http://reports-repo:8080/upload
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed

  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0
100   335  100    36  100   299   7200  59800 --:--:-- --:--:-- --:--:-- 67000
{"message":"Internal Server Error"}
----

Fix the zap-proxy task and replace the line 99, with the content of the following curl to upload properly
[source]
----
curl -u $(params.REPORTS_REPO_USERNAME):$(params.REPORTS_REPO_PASSWORD) -F path=$PIPELINERUN_NAME/$PIPELINERUN_NAME.html -F file=@/zap/wrk/$PIPELINERUN_NAME.html -X POST $(params.REPORTS_REPO_HOST)/upload; echo ""
----

After that rerun the pipeline and check that effectively the zap proxy report its uploaded to the reports server:
[source]
----
+ curl -u reports:reports -F path=petclinic-build-dev-6f4569/petclinic-build-dev-6f4569.html -F file=@/zap/wrk/petclinic-build-dev-6f4569.html -X POST http://reports-repo:8080/upload
% Total % Received % Xferd Average Speed Time Time Time Current
Dload Upload Total Spent Left Speed

0 0 0 0 0 0 0 0 --:--:-- --:--:-- --:--:-- 0
100 76435 100 89 100 76346 22250 18.2M --:File has been uploaded to petclinic-build-dev-6f4569/petclinic-build-dev-6f4569.html 🚀--:-- --:--:-- --:--:-- 18.2M
+ echo ''
----

image:images/lab4-devsecops100.png[300,700]
